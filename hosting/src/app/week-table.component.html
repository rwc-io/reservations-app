<table mat-table [dataSource]="tableRows$">
  <!-- Week Start Column -->
  <ng-container matColumnDef="week">
    <th mat-header-cell *matHeaderCellDef>Week</th>
    <td mat-cell *matCellDef="let element">
      {{ element.startDate | shortDate }} â€“
      {{ element.endDate | shortDate }}<br>
      {{ element.pricingTier?.name || '' }}
    </td>
    <td mat-footer-cell *matFooterCellDef>Pricing</td>
  </ng-container>

  <!-- Unit Columns -->
  @for (unit of units; track unit.id) {
    <ng-container [matColumnDef]="unit.name">
      <th class="unit-header" mat-header-cell *matHeaderCellDef>
        <div class="unit-header">
          <div>
            <mat-icon class="vertical-middle">gite</mat-icon>
            <div class="vertical-middle unit-name">{{ unit.name }}</div>
          </div>
          @if (unit.floorPlanFilename) {
            <div>
              <mat-icon class="vertical-middle">map</mat-icon>
              <a mat-button href="{{downloadUrls[unit.id] | async}}" target="_blank">Floor plan</a>
            </div>
          }
          @if (unit.notesMarkdown) {
            <div>
              <mat-icon class="vertical-middle">description</mat-icon>
              <button mat-button class="vertical-middle" (click)="openNotesDialog(unit)">Notes</button>
            </div>
          }
          @if (canEditUnit()) {
            <div>
              <mat-icon class="vertical-middle">edit</mat-icon>
              <button mat-button class="vertical-middle" aria-label="Edit unit" (click)="editUnit(unit)">
                Manage
              </button>
            </div>
          }
        </div>
      </th>
      <td mat-cell *matCellDef="let weekRow">
        <app-reservable-week-cell
          [weekRow]="weekRow"
          [unit]="unit"
          [unitReservations]="weekRow.reservations[unit.id] || []"
          [bookers]="bookers"
          [canAddReservation]="canAddReservation()"
          [canAddDailyReservation]="canAddDailyReservation()"
          [canEditReservationFn]="canEditReservation.bind(this)"
          (addReservation)="addReservation(weekRow, unit, $event.startDate, $event.endDate)"
          (editReservation)="editReservation($event, weekRow)"
        ></app-reservable-week-cell>
      </td>
      <td mat-footer-cell *matFooterCellDef>
        <table class="mat-mdc-table">
          @for (tier of pricingTiers; track tier.id) {
            <tr class="mat-mdc-row" [style]="rowStyle(tier)">
              <td mat-cell>
                {{ tier.name }}
              </td>
              <td class="mat-mdc-cell">
                {{ unitTierPricing(unit, tier)?.weeklyPrice | currency }}/wk<br/>
                {{ unitTierPricing(unit, tier)?.dailyPrice | currency }}/day
              </td>
            </tr>
          }
        </table>
      </td>
    </ng-container>
  }

  <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
  <tr mat-row class="weeks-content" *matRowDef="let row; columns: displayedColumns"
      [style]="rowStyle(row.pricingTier)">
  </tr>
  <tr class="mat-row" *matNoDataRow>
    <td class="mat-cell" class="weeks-content" [attr.colspan]="displayedColumns.length">
      <h2>No reservable weeks configured for {{activeYear()}}.</h2>
    </td>
  </tr>
  <tr mat-footer-row class="pricing-footer" *matFooterRowDef="displayedColumns"></tr>
</table>
